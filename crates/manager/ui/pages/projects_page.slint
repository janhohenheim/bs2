import {
    Button,
    GroupBox,
    SpinBox,
    ComboBox,
    CheckBox,
    LineEdit,
    TabWidget,
    VerticalBox,
    HorizontalBox,
    Slider,
    ProgressIndicator,
    SpinBox,
    Switch,
    Spinner,
    GridBox,
    TimePickerPopup,
    DatePickerPopup,
    Palette,
    ListView,
    StandardButton,
} from "std-widgets.slint";
import { Page } from "page.slint";
import { ProjectsPageLogic, ProjectDef, Bs2Config } from "../globals.slint";


export component ProjectsPage inherits Page {
    title: @tr("Projects");
    description: @tr("This page gives an overview of the default widget set provided by Slint. The widgets are available in different styles native, fluent-(dark/light) and material-(dark/light). The widgets can be imported from \"std-widgets.slint\".");

    property <int> last_project <=> Bs2Config.last_project;
    property <bool> is_new: project-box.current-index == 0;
    changed last_project => {
        project-box.current-index = last_project;
        project-box.current-value = ProjectsPageLogic.project-selection[last_project];
        is_new = false;
    }
    VerticalBox {
        alignment: start;
        Text {
            text: "Manage your projects and launch the Source 2 Tools. If you need help setting up the Bevy side of things, see the guide.";
        }

        HorizontalBox {
            alignment: start;
            Text {
                vertical-alignment: center;
                horizontal-alignment: right;
                text: "Project:";
            }

            project-box := ComboBox {
                model <=> ProjectsPageLogic.project-selection;
                current-index: Bs2Config.last_project;
                current-value: ProjectsPageLogic.project-selection[Bs2Config.last_project];
                selected(current-value) => {
                    is_new = current-value == ProjectsPageLogic.project-selection[0]
                }
            }
        }

        if is_new: GroupBox {
            title: "New Project";

            VerticalBox {
                alignment: start;

                GridLayout {
                    Row {
                        Text {
                            text: "Name:";
                            vertical-alignment: center;
                            horizontal-alignment: right;
                        }

                        Rectangle {
                            background: ProjectsPageLogic.new-project-name-err == "" ? Palette.background : red.with-alpha(0.2);

                            HorizontalLayout {
                                LineEdit {
                                    text <=> ProjectsPageLogic.new-project-name;
                                    placeholder-text: "project_name";
                                    accepted => {
                                        create-btn.clicked()
                                    }
                                    changed text => {
                                        ProjectsPageLogic.validate-new-project-name(self.text)
                                    }
                                    horizontal_stretch: 1;
                                }
                            }
                        }

                        Rectangle { }
                    }

                    Row {
                        Rectangle { }

                        Text {
                            text: ProjectsPageLogic.new-project-name-err;
                            color: red;
                            vertical-alignment: center;
                            wrap: word-wrap;
                            height: 20px;
                        }

                        Rectangle { }
                    }

                    Row {
                        Text {
                            text: "Directory:";
                            vertical-alignment: center;
                            horizontal-alignment: right;
                            width: 80px;
                        }

                        Rectangle {
                            background: ProjectsPageLogic.new-project-path-err == "" ? Palette.background : red.with-alpha(0.2);
                            HorizontalLayout {
                                LineEdit {
                                    text <=> ProjectsPageLogic.new-project-path;
                                    placeholder-text: "Path where project data should be exported to";
                                    accepted => {
                                        create-btn.clicked()
                                    }
                                    changed text => {
                                        ProjectsPageLogic.validate-new-project-path(self.text)
                                    }
                                    horizontal_stretch: 1;
                                }
                            }
                        }

                        Button {
                            text: "ðŸ“‚";
                            width: 40px;
                            clicked => {
                                ProjectsPageLogic.pick-project(ProjectsPageLogic.new-project-path);
                            }
                        }
                    }

                    Row {
                        Rectangle { }

                        Text {
                            text: ProjectsPageLogic.new-project-path-err;
                            color: red;
                            vertical-alignment: center;
                            wrap: word-wrap;
                            height: 20px;
                        }

                        Rectangle { }
                    }
                }

                create-btn := Button {
                    text: "Create";
                    enabled: ProjectsPageLogic.new-project-name-err == "" && ProjectsPageLogic.new-project-path-err == "" && ProjectsPageLogic.new-project-name != "" && ProjectsPageLogic.new-project-path != "";
                    clicked => {
                        ProjectsPageLogic.create-project();
                        ProjectsPageLogic.update-project-selection();
                    }
                }
            }
        }
        if !is_new: GroupBox {
            title: project-box.current-value;
            VerticalBox {
                HorizontalBox {
                    alignment: start;
                    Text {
                        text: "Path:";
                        vertical-alignment: center;
                        horizontal-alignment: right;
                    }

                    Text {
                        text: ProjectsPageLogic.read-project(project-box.current-value).path;
                        vertical-alignment: center;
                        horizontal-alignment: right;
                    }
                }

                Button {
                    text: "Launch Tools";
                    clicked => {
                        ProjectsPageLogic.launch-tools(project-box.current-value)
                    }
                }
            }
        }
    }

    Rectangle { }
}
